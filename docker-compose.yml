version: '3.8'

services:
  license-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lib-validate-license
    ports:
      - "8199:8199"
    environment:
      # Server configuration
      - SERVER_PORT=8199
      - SPRING_PROFILES_ACTIVE=prod

      # JWE Security configuration (REQUIRED - change in production!)
      - JWE_SECRET_KEY=change-this-secret-key-in-production-min-32-chars
      - JWE_EXPIRATION_SECONDS=3600
      - JWE_ISSUER=lib-validate-license

      # H2 Database configuration
      - H2_CONSOLE_ENABLED=false

      # Email configuration (MailerSend REST API)
      - MAILERSEND_API_TOKEN=
      - MAILERSEND_API_URL=https://api.mailersend.com/v1/email
      - EMAIL_FROM=
      - EMAIL_ENABLED=true

      # Scheduler configuration
      - SCHEDULER_ENABLED=true
      - SCHEDULER_CRON=0 0 9 * * ?

      # Backup configuration (Cloudflare R2)
      - BACKUP_ENABLED=true
      - BACKUP_RUN_ON_STARTUP=true
      - BACKUP_CRON=0 0 1 * * ?
      - BACKUP_LOCAL_DIR=/app/data/backups
      - BACKUP_MAX_FILES=7
      - R2_ACCOUNT_ID=
      - R2_ACCESS_KEY_ID=
      - R2_SECRET_ACCESS_KEY=
      - R2_BUCKET_NAME=licenses-backup

    volumes:
      # Persist H2 database data
      - license-data:/app/data
      # Persist local backup files
      - license-backups:/app/data/backups
      # Optional: external log directory
      - ./logs:/logs/lib-validate-license
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8199/actuator/health"]
      interval: 30s
      timeout: 3s
      start_period: 40s
      retries: 3
    networks:
      - license-network

volumes:
  license-data:
    driver: local
  license-backups:
    driver: local

networks:
  license-network:
    driver: bridge
